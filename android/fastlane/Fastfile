
default_platform(:android)

platform :android do
  desc "Runs all the tests"
  lane :test do |options|
   notes  = options[:notes] ? options[:notes] : 'Pre-release Testing version. auto-generated by CI Jenkins.'
    gradle(task: "clean")
  plugins_path = File.expand_path(File.dirname(__FILE__),'../keystores/rlkey')
    gradle(
      task: "assemble",
      build_type: "Release",
      print_command: true,
      print_command_output: true,
      properties: {
        "android.injected.signing.store.file" => plugins_path,
        "android.injected.signing.store.password" => "74121311",
        "android.injected.signing.key.alias" => "marvistadev",
        "android.injected.signing.key.password" => "74121311",
      }
    )
    gradle(
          task: "bundle",
          build_type: "Release",
          print_command: true,
          print_command_output: true,
          properties: {
            "android.injected.signing.store.file" => plugins_path,
            "android.injected.signing.store.password" => "74121311",
            "android.injected.signing.key.alias" => "marvistadev",
            "android.injected.signing.key.password" => "74121311",
          }
        )
  output_path = File.expand_path(File.dirname(__FILE__),'../../build/app/outputs/apk/release/output-metadata.json')
  content = load_json(json_path: output_path)
  path = "../../build/app/outputs/apk/release/"+ content["elements"][0]["outputFile"]
  apk_path = File.expand_path(File.dirname(__FILE__),path)
     firebase_app_distribution(
                   apk_path:apk_path,
                   firebase_cli_token:"1//0d92zdLlYiE1gCgYIARAAGA0SNwF-L9IrPZ7JL7UXBXUu4EnlgXAEWKYMIYO7YsfC7JJAPs_n259AW2SBW4AxeAcQCKJnEImiAUc",
                   app: "1:256285981176:android:cadab88fc1e3b17c1ebe0d",
                   testers: "trongnghia.nguyen@ogilvy.com,hoanggia.tran@ogilvy.com,nhatduy.tran@ogilvy.com,ogilvydrive.storage@gmail.com",
                   groups:"Ogilvy_Test",
                   release_notes: notes
               )

  end
end

